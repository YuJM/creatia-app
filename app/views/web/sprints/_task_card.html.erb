<%# app/views/web/sprints/_task_card.html.erb %>
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-move hover:shadow-md transition-shadow"
     data-task-id="<%= task.id %>"
     data-controller="task-card"
     data-task-card-task-id-value="<%= task.id %>"
     data-task-card-service-id-value="<%= @service.id %>">
  
  <!-- Task Header -->
  <div class="flex items-start justify-between mb-2">
    <div class="flex-1">
      <!-- Task ID and Type -->
      <div class="flex items-center space-x-2 mb-1">
        <span class="text-xs font-medium text-gray-500">
          <%= task.task_id %>
        </span>
        
        <!-- Task Type Badge -->
        <span class="px-2 py-0.5 text-xs font-medium rounded-full
          <%= case task.task_type
              when 'bug' then 'bg-red-100 text-red-700'
              when 'feature' then 'bg-blue-100 text-blue-700'
              when 'chore' then 'bg-gray-100 text-gray-700'
              when 'spike' then 'bg-purple-100 text-purple-700'
              else 'bg-gray-100 text-gray-700'
              end %>">
          <%= task.task_type %>
        </span>
      </div>
      
      <!-- Task Title -->
      <h4 class="text-sm font-medium text-gray-900 line-clamp-2">
        <%= link_to task.title, web_service_task_path(@service, task),
            class: "hover:text-indigo-600",
            data: { turbo_frame: "_top" } %>
      </h4>
    </div>
    
    <!-- Priority Indicator -->
    <div class="ml-2">
      <% case task.priority %>
      <% when 'urgent' %>
        <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM10 12a1 1 0 01-1-1V7a1 1 0 112 0v4a1 1 0 01-1 1zm0 2a1 1 0 100 2 1 1 0 000-2z"/>
        </svg>
      <% when 'high' %>
        <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2l2.39 7.35H20l-6.18 4.5L16.21 18 10 13.5 3.79 18l2.39-6.15L0 7.35h7.61L10 2z"/>
        </svg>
      <% when 'low' %>
        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
        </svg>
      <% end %>
    </div>
  </div>
  
  <!-- Labels -->
  <% if task.labels.present? %>
    <div class="flex flex-wrap gap-1 mb-2">
      <% task.labels.each do |label| %>
        <span class="px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded">
          <%= label %>
        </span>
      <% end %>
    </div>
  <% end %>
  
  <!-- Task Meta Info -->
  <div class="flex items-center justify-between text-xs text-gray-500">
    <div class="flex items-center space-x-3">
      <!-- Story Points -->
      <% if task.story_points.present? %>
        <div class="flex items-center">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          <span><%= task.story_points %> pts</span>
        </div>
      <% end %>
      
      <!-- Comments Count -->
      <% if task.comment_count > 0 %>
        <div class="flex items-center">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          <span><%= task.comment_count %></span>
        </div>
      <% end %>
      
      <!-- Subtasks Progress -->
      <% if task.subtasks.present? && task.subtasks.any? %>
        <div class="flex items-center">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <span>
            <%= task.subtasks.count { |s| s[:completed] } %>/<%= task.subtasks.size %>
          </span>
        </div>
      <% end %>
    </div>
    
    <!-- Assignee Avatar -->
    <% if task.assignee_name.present? %>
      <div class="flex items-center">
        <div class="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-white text-xs font-medium"
             title="<%= task.assignee_name %>">
          <%= task.assignee_name.first.upcase %>
        </div>
      </div>
    <% else %>
      <button class="text-gray-400 hover:text-gray-600"
              data-action="click->task-card#assignToMe"
              title="Assign to me">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
      </button>
    <% end %>
  </div>
  
  <!-- Blocked Indicator -->
  <% if task.is_blocked %>
    <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
      <div class="flex items-center">
        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
        </svg>
        Blocked: <%= task.blocked_reason %>
      </div>
    </div>
  <% end %>
  
  <!-- Due Date Warning -->
  <% if task.due_date.present? && task.due_date <= 3.days.from_now %>
    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-700">
      <div class="flex items-center">
        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
        </svg>
        Due <%= distance_of_time_in_words_to_now(task.due_date) %>
      </div>
    </div>
  <% end %>
</div>