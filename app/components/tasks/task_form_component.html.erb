<%= turbo_frame_tag "task_form" do %>
  <%= form_with model: task, 
                url: form_action_url,
                method: form_method,
                data: { 
                  controller: "task-form",
                  action: "turbo:submit-end->task-form#handleSubmit"
                },
                class: "space-y-6" do |form| %>
    
    <!-- Error Messages -->
    <% if task.errors&.any? %>
      <%= render AlertComponent.new(
        type: :error,
        title: "다음 오류를 수정해주세요:",
        messages: task.errors.full_messages
      ) %>
    <% end %>

    <!-- Title & Description -->
    <%= render Ui::CardComponent.new(variant: :default, padding: :default) do %>
      <div class="space-y-6">
        <div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">기본 정보</h3>
          
          <!-- Title -->
          <div class="mb-4">
            <%= form.label :title, "제목 *", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.text_field :title,
                                value: task.title,
                                class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                                placeholder: "태스크 제목을 입력하세요",
                                required: true,
                                data: { task_form_target: "title" } %>
          </div>

          <!-- Description -->
          <div>
            <%= form.label :description, "설명", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.text_area :description,
                               value: task.description,
                               rows: 5,
                               class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                               placeholder: "태스크에 대한 상세 설명을 입력하세요",
                               data: { task_form_target: "description" } %>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              마크다운 문법을 지원합니다
            </p>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Status & Assignment -->
    <%= render Ui::CardComponent.new(variant: :default, padding: :default) do %>
      <div class="space-y-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">상태 및 할당</h3>
        
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <!-- Status -->
          <div>
            <%= form.label :status, "상태", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.select :status,
                            options_for_select(status_options, task.status),
                            {},
                            class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                            data: { task_form_target: "status" } %>
          </div>

          <!-- Priority -->
          <div>
            <%= form.label :priority, "우선순위", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.select :priority,
                            options_for_select(priority_options, task.priority),
                            {},
                            class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                            data: { task_form_target: "priority" } %>
          </div>

          <!-- Assignee -->
          <div>
            <%= form.label :assignee_id, "담당자", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.select :assignee_id,
                            options_for_select(assignee_options, task.assignee&.id),
                            {},
                            class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                            data: { task_form_target: "assignee" } %>
          </div>

          <!-- Sprint -->
          <div>
            <%= form.label :sprint_id, "스프린트", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.select :sprint_id,
                            options_for_select(sprint_options, task.sprint&.dig("id")),
                            {},
                            class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                            data: { task_form_target: "sprint" } %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Schedule & Time Tracking -->
    <%= render Ui::CardComponent.new(variant: :default, padding: :default) do %>
      <div class="space-y-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">일정 및 시간 추적</h3>
        
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <!-- Start Date -->
          <div>
            <%= form.label :start_date, "시작일", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.date_field :start_date,
                                value: task.start_date,
                                class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                                data: { task_form_target: "startDate" } %>
          </div>

          <!-- Due Date -->
          <div>
            <%= form.label :due_date, "마감일", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.date_field :due_date,
                                value: task.due_date,
                                class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                                data: { task_form_target: "dueDate" } %>
          </div>

          <!-- Estimated Hours -->
          <div>
            <%= form.label :estimated_hours, "예상 시간", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <div class="relative rounded-md shadow-sm">
              <%= form.number_field :estimated_hours,
                                    value: task.estimated_hours,
                                    step: 0.5,
                                    min: 0,
                                    class: "focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-12 sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                                    placeholder: "0",
                                    data: { task_form_target: "estimatedHours" } %>
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <span class="text-gray-500 dark:text-gray-400 sm:text-sm">시간</span>
              </div>
            </div>
          </div>

          <!-- Actual Hours (if editing) -->
          <% if task.id.present? %>
            <div>
              <%= form.label :actual_hours, "실제 시간", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
              <div class="relative rounded-md shadow-sm">
                <%= form.number_field :actual_hours,
                                      value: task.actual_hours,
                                      step: 0.5,
                                      min: 0,
                                      class: "focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-12 sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                                      placeholder: "0",
                                      data: { task_form_target: "actualHours" } %>
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                  <span class="text-gray-500 dark:text-gray-400 sm:text-sm">시간</span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Tags & Labels -->
    <%= render Ui::CardComponent.new(variant: :default, padding: :default) do %>
      <div class="space-y-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">태그 및 라벨</h3>
        
        <div class="space-y-4">
          <!-- Tags -->
          <div>
            <%= form.label :tags, "태그", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.text_field :tags,
                                value: tags_value,
                                class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                                placeholder: "태그를 쉼표로 구분하여 입력 (예: frontend, bug, urgent)",
                                data: { 
                                  task_form_target: "tags",
                                  controller: "tag-input",
                                  action: "keydown->tag-input#handleKeydown"
                                } %>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Enter 키로 태그를 추가할 수 있습니다
            </p>
            
            <!-- Tag Preview -->
            <div class="mt-2 flex flex-wrap gap-2" data-tag-input-target="preview">
              <% if task.tags.present? && task.tags.is_a?(Array) %>
                <% task.tags.each do |tag| %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400">
                    <%= tag %>
                    <button type="button" class="ml-1 inline-flex items-center justify-center w-4 h-4 text-indigo-400 hover:text-indigo-600">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </span>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- Labels -->
          <div>
            <%= form.label :labels, "라벨", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= form.text_field :labels,
                                value: labels_value,
                                class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-md",
                                placeholder: "라벨을 쉼표로 구분하여 입력 (예: epic:auth, feature)",
                                data: { task_form_target: "labels" } %>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Epic 라벨은 'epic:' 접두사를 사용하세요
            </p>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Form Actions -->
    <div class="flex items-center justify-between pt-6 border-t border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <%= link_to "취소",
                    task.id.present? ? task_path(task.id) : tasks_path,
                    class: "inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                    data: { turbo_frame: "_top" } %>
      </div>

      <div class="flex items-center gap-3">
        <% if task.id.present? %>
          <%= link_to "삭제",
                      task_path(task.id),
                      method: :delete,
                      data: { 
                        confirm: "정말로 이 태스크를 삭제하시겠습니까?",
                        turbo_frame: "_top"
                      },
                      class: "inline-flex items-center px-4 py-2 border border-red-300 dark:border-red-700 shadow-sm text-sm font-medium rounded-md text-red-700 dark:text-red-400 bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" %>
        <% end %>

        <%= form.submit submit_button_text,
                        class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
                        data: { task_form_target: "submitButton" } %>
      </div>
    </div>
  <% end %>
<% end %>