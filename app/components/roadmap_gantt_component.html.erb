<%# Roadmap Gantt Component - 프로젝트 간트 차트 %>
<%= turbo_frame_tag "roadmap_gantt",
                    class: "roadmap-gantt",
                    data: {
                      controller: "roadmap-gantt",
                      roadmap_gantt_service_id_value: service.id,
                      turbo_permanent: true
                    } do %>

  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 px-6 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">📊 간트 차트</h2>
          <p class="text-indigo-100 text-sm mt-1">
            <%= formatted_date(date_range[:start_date]) %> ~ <%= formatted_date(date_range[:end_date]) %>
            • <%= total_days %>일 기간 • <%= gantt_tasks.count %>개 작업
          </p>
        </div>

        <div class="flex items-center space-x-3">
          <!-- View Options -->
          <div class="relative" data-controller="dropdown">
            <button type="button"
                    data-action="click->dropdown#toggle"
                    class="text-indigo-100 hover:text-white px-3 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center space-x-2">
              <span class="text-sm">보기 옵션</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden"
                 data-dropdown-target="menu">
              <button class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      data-action="click->roadmap-gantt#toggleCriticalPath">
                <span class="mr-2">🎯</span>
                임계경로 표시
              </button>
              <button class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      data-action="click->roadmap-gantt#toggleDependencies">
                <span class="mr-2">🔗</span>
                의존성 표시
              </button>
              <button class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      data-action="click->roadmap-gantt#toggleMilestones">
                <span class="mr-2">📍</span>
                마일스톤 표시
              </button>
            </div>
          </div>

          <!-- Refresh Button -->
          <button type="button"
                  data-action="click->roadmap-gantt#refresh"
                  class="text-indigo-100 hover:text-white p-2 rounded-full hover:bg-indigo-700 transition-colors"
                  title="새로고침">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="p-6">
      <!-- Summary Stats -->
      <div class="mb-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
        <% gantt_summary_stats.each do |key, value| %>
          <% next if key == :completion_rate %>
          <div class="text-center">
            <div class="text-2xl font-bold <%= case key
                                               when :done then 'text-green-600'
                                               when :in_progress then 'text-blue-600'
                                               when :blocked then 'text-red-600'
                                               when :critical_path then 'text-purple-600'
                                               when :high_priority then 'text-orange-600'
                                               else 'text-gray-600'
                                               end %>">
              <%= value %>
            </div>
            <div class="text-xs text-gray-500 uppercase tracking-wide">
              <%= case key
                  when :total then '전체'
                  when :done then '완료'
                  when :in_progress then '진행중'
                  when :todo then '대기'
                  when :blocked then '블록됨'
                  when :critical_path then '임계경로'
                  when :high_priority then '높은우선순위'
                  end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Progress Overview -->
      <div class="mb-6 bg-gray-50 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-700">전체 진행률</span>
          <span class="text-sm font-semibold text-gray-900">
            <%= gantt_summary_stats[:completion_rate] %>%
          </span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all duration-300"
               style="width: <%= gantt_summary_stats[:completion_rate] %>%"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span><%= gantt_summary_stats[:done] %>개 완료</span>
          <span><%= gantt_summary_stats[:total] %>개 중</span>
        </div>
      </div>

      <!-- Alerts for Overdue Tasks -->
      <% if overdue_tasks.any? %>
        <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex items-center">
            <svg class="h-5 w-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            <div>
              <h3 class="text-sm font-medium text-red-800">
                지연 경고
              </h3>
              <p class="text-sm text-red-700">
                <%= overdue_tasks.count %>개 작업이 예정일을 넘어서 진행 중입니다.
              </p>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Legend -->
      <div class="mb-6 bg-gray-50 rounded-lg p-4">
        <h3 class="text-sm font-medium text-gray-700 mb-3">범례</h3>
        <div class="flex flex-wrap gap-4">
          <% legend_items.each do |item| %>
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 rounded <%= item[:extra] == 'critical-path' ? 'border-2 border-red-500' : '' %>"
                   style="background-color: <%= item[:color] %>"></div>
              <span class="text-xs text-gray-600"><%= item[:label] %></span>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Gantt Chart Container -->
      <div class="bg-white border rounded-lg overflow-hidden">
        <!-- Chart Header -->
        <div class="bg-gray-50 px-4 py-3 border-b">
          <div class="flex items-center justify-between">
            <h3 class="font-medium text-gray-900">작업 타임라인</h3>
            <div class="text-sm text-gray-500">
              오늘: <%= Date.current.strftime('%Y.%m.%d') %>
            </div>
          </div>
        </div>

        <!-- Scrollable Chart Area -->
        <div class="overflow-x-auto" style="max-height: 600px;">
          <div class="relative" style="min-width: 800px;">
            <!-- Gantt Chart SVG -->
            <div class="gantt-chart-container" data-roadmap-gantt-target="chartContainer">
              <%= generate_gantt_svg %>
              
              <!-- Milestone Markers -->
              <div class="absolute inset-0 pointer-events-none">
                <%= render_milestone_markers.html_safe %>
              </div>
            </div>

            <!-- Task Labels (Left Side) -->
            <div class="absolute left-0 top-0 bg-white border-r" style="width: 250px;">
              <div class="bg-gray-50 px-4 py-3 border-b font-medium text-gray-900">
                작업 목록
              </div>
              <% gantt_tasks.each_with_index do |task, index| %>
                <div class="px-4 py-2 border-b hover:bg-gray-50 cursor-pointer"
                     style="height: <%= task_row_height %>px;"
                     data-task-id="<%= task[:id] %>"
                     data-action="click->roadmap-gantt#selectTask">
                  
                  <div class="flex items-center space-x-2">
                    <% priority = task_priority_indicator(task) %>
                    <span class="<%= priority[:class] %>"><%= priority[:icon] %></span>
                    <span class="text-sm text-gray-900 truncate flex-1" title="<%= task[:title] %>">
                      <%= task[:title] %>
                    </span>
                    <% if is_critical_path_task(task[:id]) %>
                      <span class="text-xs bg-red-100 text-red-800 px-1 rounded">Critical</span>
                    <% end %>
                  </div>
                  
                  <div class="flex items-center justify-between mt-1">
                    <span class="text-xs text-gray-500">
                      <%= task[:assignees]&.first || '미배정' %>
                    </span>
                    <div class="flex items-center space-x-1">
                      <span class="text-xs px-1.5 py-0.5 rounded-full <%= case task[:status]
                                                                           when 'done' then 'bg-green-100 text-green-800'
                                                                           when 'in_progress' then 'bg-blue-100 text-blue-800'
                                                                           when 'blocked' then 'bg-red-100 text-red-800'
                                                                           else 'bg-gray-100 text-gray-800'
                                                                           end %>">
                        <%= task[:status].humanize %>
                      </span>
                      <span class="text-xs text-gray-500">
                        <%= task[:progress] %>%
                      </span>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Epic-based Task Grouping -->
      <div class="mt-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Epic별 작업 현황</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <% grouped_tasks_by_epic.each do |epic_name, tasks| %>
            <div class="bg-gray-50 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-gray-900"><%= epic_name %></h4>
                <span class="text-sm text-gray-500"><%= tasks.count %>개</span>
              </div>
              
              <!-- Epic Progress -->
              <div class="mb-3">
                <div class="flex justify-between text-xs text-gray-600 mb-1">
                  <span>진행률</span>
                  <span><%= epic_progress(tasks) %>%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-500 h-2 rounded-full transition-all duration-300"
                       style="width: <%= epic_progress(tasks) %>%"></div>
                </div>
              </div>
              
              <!-- Status Summary -->
              <% status_summary = epic_status_summary(tasks) %>
              <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="flex justify-between">
                  <span class="text-green-600">완료</span>
                  <span><%= status_summary[:done] %></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-blue-600">진행중</span>
                  <span><%= status_summary[:in_progress] %></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">대기</span>
                  <span><%= status_summary[:todo] %></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-red-600">블록됨</span>
                  <span><%= status_summary[:blocked] %></span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Critical Path Analysis -->
      <% if critical_path.any? %>
        <div class="mt-8 bg-purple-50 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">🎯 임계경로 분석</h3>
          <p class="text-sm text-gray-600 mb-4">
            다음 작업들이 프로젝트의 전체 일정에 가장 큰 영향을 미칩니다.
          </p>
          
          <div class="space-y-3">
            <% critical_path.each do |cp| %>
              <% task = gantt_tasks.find { |t| t[:id] == cp[:task_id] } %>
              <% next unless task %>
              <div class="bg-white rounded-lg p-3 border-l-4 border-purple-500">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-medium text-gray-900"><%= task[:title] %></h4>
                  <span class="text-sm font-semibold text-purple-600">
                    영향도: <%= cp[:impact_score] %>
                  </span>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-600">
                  <span>
                    <%= formatted_date(task[:start_date]) %> ~ <%= formatted_date(task[:end_date]) %>
                  </span>
                  <span>여유시간: <%= cp[:slack] %>일</span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Dependencies Analysis -->
      <% if dependencies.any? %>
        <div class="mt-8 bg-blue-50 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">🔗 의존성 분석</h3>
          <p class="text-sm text-gray-600 mb-4">
            총 <%= dependencies.count %>개의 작업 간 의존성이 식별되었습니다.
          </p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- High Dependency Tasks -->
            <div>
              <h4 class="font-medium text-gray-900 mb-2">의존성이 높은 작업</h4>
              <% high_dep_tasks = gantt_tasks.select { |t| task_dependencies_for(t[:id]).count >= 2 } %>
              <% if high_dep_tasks.any? %>
                <div class="space-y-2">
                  <% high_dep_tasks.first(5).each do |task| %>
                    <div class="text-sm bg-white rounded p-2">
                      <span class="font-medium"><%= task[:title] %></span>
                      <span class="text-gray-500 ml-2">
                        (<%= task_dependencies_for(task[:id]).count %>개 의존)
                      </span>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <p class="text-sm text-gray-500">해당 작업이 없습니다.</p>
              <% end %>
            </div>
            
            <!-- Blocking Tasks -->
            <div>
              <h4 class="font-medium text-gray-900 mb-2">다른 작업을 블록하는 작업</h4>
              <% blocking_tasks = gantt_tasks.select { |t| task_dependents_for(t[:id]).count >= 2 } %>
              <% if blocking_tasks.any? %>
                <div class="space-y-2">
                  <% blocking_tasks.first(5).each do |task| %>
                    <div class="text-sm bg-white rounded p-2">
                      <span class="font-medium"><%= task[:title] %></span>
                      <span class="text-gray-500 ml-2">
                        (<%= task_dependents_for(task[:id]).count %>개 블록)
                      </span>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <p class="text-sm text-gray-500">해당 작업이 없습니다.</p>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Loading Overlay -->
    <div class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center"
         data-roadmap-gantt-target="loadingOverlay">
      <div class="flex items-center space-x-3">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-sm text-gray-600">간트 차트를 업데이트하고 있습니다...</span>
      </div>
    </div>
  </div>
<% end %>