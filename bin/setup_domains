#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}🌐 Domain Setup Script${NC}"
echo ""

# Detect environment
if [ "$1" == "test" ]; then
    ENVIRONMENT="test"
    BASE_DOMAIN="localhost.test"
    DOMAINS=(
        "localhost.test"
        "www.localhost.test"
        "auth.localhost.test"
        "api.localhost.test"
        "admin.localhost.test"
        "org1.localhost.test"
        "org2.localhost.test"
        "testorg.localhost.test"
    )
elif [ "$1" == "dev" ] || [ "$1" == "development" ]; then
    ENVIRONMENT="development"
    BASE_DOMAIN="creatia.local"
    DOMAINS=(
        "creatia.local"
        "www.creatia.local"
        "auth.creatia.local"
        "api.creatia.local"
        "admin.creatia.local"
        "demo.creatia.local"
        "test.creatia.local"
    )
else
    echo -e "${YELLOW}Usage: $0 [test|dev|development]${NC}"
    echo ""
    echo "Examples:"
    echo "  $0 test       # Setup test domains (localhost.test)"
    echo "  $0 dev        # Setup development domains (creatia.local)"
    exit 1
fi

echo -e "${GREEN}Setting up $ENVIRONMENT environment with BASE_DOMAIN=$BASE_DOMAIN${NC}"
echo ""

# Check if running with sudo
if [ "$EUID" -ne 0 ]; then
    echo -e "${YELLOW}⚠️  This script needs to modify /etc/hosts and requires sudo privileges.${NC}"
    echo "Please run: sudo $0 $1"
    exit 1
fi

# Backup /etc/hosts
BACKUP_FILE="/etc/hosts.backup.$(date +%Y%m%d-%H%M%S)"
cp /etc/hosts "$BACKUP_FILE"
echo -e "${GREEN}✅ Backed up /etc/hosts to $BACKUP_FILE${NC}"

# Remove old entries for this domain
echo -e "${YELLOW}Cleaning old entries for $BASE_DOMAIN...${NC}"
grep -v "$BASE_DOMAIN" /etc/hosts > /tmp/hosts.tmp
mv /tmp/hosts.tmp /etc/hosts

# Add new entries
echo "" >> /etc/hosts
echo "# CreatiaApp $ENVIRONMENT domains (BASE_DOMAIN=$BASE_DOMAIN)" >> /etc/hosts

for domain in "${DOMAINS[@]}"; do
    echo "127.0.0.1 $domain" >> /etc/hosts
    echo -e "${GREEN}✅ Added $domain${NC}"
done

echo "# End of CreatiaApp $ENVIRONMENT domains" >> /etc/hosts

echo ""
echo -e "${GREEN}✅ Domain setup complete!${NC}"
echo ""

# Show environment-specific instructions
if [ "$ENVIRONMENT" == "test" ]; then
    echo -e "${BLUE}Test Environment Setup:${NC}"
    echo "1. Run tests with Caddy proxy:"
    echo "   bin/test_simple"
    echo "   bin/run_system_tests"
    echo ""
    echo "2. Environment variable is set to:"
    echo "   BASE_DOMAIN=localhost.test"
    echo ""
    echo "3. Access URLs:"
    echo "   Main: http://localhost.test:8080"
    echo "   Auth: http://auth.localhost.test:8080"
    echo "   API: http://api.localhost.test:8080"
    echo "   Admin: http://admin.localhost.test:8080"
else
    echo -e "${BLUE}Development Environment Setup:${NC}"
    echo "1. Set environment variable:"
    echo "   export BASE_DOMAIN=creatia.local"
    echo "   or add to .env file"
    echo ""
    echo "2. Start development with Caddy:"
    echo "   # Terminal 1: Rails server"
    echo "   bin/rails server"
    echo ""
    echo "   # Terminal 2: Caddy proxy"
    echo "   caddy run --config Caddyfile.dev --adapter caddyfile"
    echo ""
    echo "3. Access URLs:"
    echo "   Main: http://creatia.local:8080"
    echo "   Auth: http://auth.creatia.local:8080"
    echo "   API: http://api.creatia.local:8080"
    echo "   Admin: http://admin.creatia.local:8080"
fi