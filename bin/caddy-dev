#!/bin/bash

# Caddy ê°œë°œ ì„œë²„ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# 80ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì˜µì…˜ ì œê³µ

echo "ðŸš€ Caddy ê°œë°œ ì„œë²„ ì‹œìž‘..."
echo "================================"

# ë°©ë²• 1: sudoë¡œ ì‹¤í–‰ (ê¶Œìž¥)
if [ "$1" = "sudo" ]; then
    echo "ðŸ“Œ sudo ê¶Œí•œìœ¼ë¡œ 80ë²ˆ í¬íŠ¸ì—ì„œ Caddy ì‹¤í–‰"
    caddy run --config Caddyfile.dev --adapter caddyfile
    
# ë°©ë²• 2: í¬íŠ¸ í¬ì›Œë”© ì‚¬ìš© (pfctl)
elif [ "$1" = "forward" ]; then
    echo "ðŸ“Œ í¬íŠ¸ í¬ì›Œë”© ì„¤ì • (8080 â†’ 80)"
    echo "rdr pass inet proto tcp from any to any port 80 -> 127.0.0.1 port 8080" | sudo pfctl -ef -
    
    # 8080 í¬íŠ¸ìš© Caddyfile ìƒì„±
    cat > Caddyfile.dev.8080 <<EOF
# Port forwarding configuration (8080 â†’ 80)
http://:8080 {
    @main host creatia.local www.creatia.local
    @auth host auth.creatia.local
    @api host api.creatia.local  
    @admin host admin.creatia.local
    
    handle {
        reverse_proxy localhost:3000 {
            header_up Host {http.request.host}
            header_up X-Real-IP {remote}
            header_up X-Original-Host {http.request.host}
        }
    }
}
EOF
    
    caddy run --config Caddyfile.dev.8080 --adapter caddyfile
    
    # ì¢…ë£Œ ì‹œ í¬íŠ¸ í¬ì›Œë”© í•´ì œ
    trap "pfctl -F all -f /etc/pf.conf" EXIT
    
# ë°©ë²• 3: ê¸°ë³¸ 80ë²ˆ í¬íŠ¸ (sudo ìžë™ ìš”ì²­)
else
    echo "ðŸ“Œ ê¸°ë³¸ 80ë²ˆ í¬íŠ¸ì—ì„œ Caddy ì‹¤í–‰"
    echo "âš ï¸  sudo ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤"
    sudo caddy run --config Caddyfile.dev --adapter caddyfile
fi