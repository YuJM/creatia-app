#!/usr/bin/env bash

# Caddy development server script
# Runs Caddy with the development configuration (no sudo required)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Caddy is installed
if ! command -v caddy &> /dev/null; then
    echo -e "${RED}Error: Caddy is not installed${NC}"
    echo "Install Caddy with: brew install caddy"
    exit 1
fi

# Use development Caddyfile
CADDYFILE="Caddyfile.dev"

# Check if Caddyfile.dev exists
if [ ! -f "$CADDYFILE" ]; then
    echo -e "${YELLOW}Creating Caddyfile.dev...${NC}"
    cat > Caddyfile.dev << 'EOF'
# Development environment Caddy configuration
# 
# Add these to /etc/hosts:
# 127.0.0.1 creatia.local
# 127.0.0.1 auth.creatia.local
# 127.0.0.1 api.creatia.local
# 127.0.0.1 admin.creatia.local
# 127.0.0.1 demo.creatia.local
# 127.0.0.1 test.creatia.local

{
	auto_https off
	admin off
}

# Main domain (www or no subdomain)
http://creatia.local, http://www.creatia.local {
    reverse_proxy localhost:3000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Original-Host {http.request.host}
    }
}

# Auth subdomain (SSO authentication)
http://auth.creatia.local {
    reverse_proxy localhost:3000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Original-Host {http.request.host}
    }
}

# API subdomain
http://api.creatia.local {
    reverse_proxy localhost:3000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Original-Host {http.request.host}
    }
}

# Admin subdomain
http://admin.creatia.local {
    reverse_proxy localhost:3000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Original-Host {http.request.host}
    }
}

# Wildcard for organization subdomains
http://*.creatia.local {
    reverse_proxy localhost:3000 {
        header_up Host {http.request.host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Original-Host {http.request.host}
    }
}

# Health check endpoint
http://localhost/health {
    respond "OK" 200
}
EOF
fi

echo -e "${GREEN}Starting Caddy development server...${NC}"
echo "Main: http://creatia.local"
echo "Auth: http://auth.creatia.local"
echo "API:  http://api.creatia.local"
echo ""

# Run Caddy with the development configuration
exec caddy run --config "$CADDYFILE" --adapter caddyfile