#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}🔧 Setting up test domains in /etc/hosts...${NC}"

# Test domains to add
DOMAINS=(
    "localhost.test"
    "www.localhost.test"
    "auth.localhost.test"
    "api.localhost.test"
    "admin.localhost.test"
    "org1.localhost.test"
    "org2.localhost.test"
    "testorg.localhost.test"
    "unauthorized.localhost.test"
)

# Check if running with sudo
if [ "$EUID" -ne 0 ]; then
    echo -e "${YELLOW}⚠️  This script needs to modify /etc/hosts and requires sudo privileges.${NC}"
    echo "Please run: sudo bin/setup_test_hosts"
    exit 1
fi

# Backup /etc/hosts
cp /etc/hosts /etc/hosts.backup.$(date +%Y%m%d-%H%M%S)
echo "Backed up /etc/hosts"

# Add marker for our test domains
echo "" >> /etc/hosts
echo "# CreatiaApp test domains (added by setup_test_hosts)" >> /etc/hosts

# Add each domain
for domain in "${DOMAINS[@]}"; do
    # Check if domain already exists
    if grep -q "$domain" /etc/hosts; then
        echo -e "${YELLOW}⚠️  $domain already exists in /etc/hosts${NC}"
    else
        echo "127.0.0.1 $domain" >> /etc/hosts
        echo -e "${GREEN}✅ Added $domain${NC}"
    fi
done

echo "# End of CreatiaApp test domains" >> /etc/hosts

echo -e "${GREEN}✅ Test domains setup complete!${NC}"
echo ""
echo "You can now run the tests with:"
echo "  bin/test_with_caddy"