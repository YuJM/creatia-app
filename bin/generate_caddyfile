#!/bin/bash

# Caddyfile ìƒì„± ìŠ¤í¬ë¦½íŠ¸
# í™˜ê²½ë³€ìˆ˜ BASE_DOMAINì„ ì‚¬ìš©í•˜ì—¬ Caddyfileì„ ìƒì„±í•©ë‹ˆë‹¤

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# BASE_DOMAIN í™˜ê²½ë³€ìˆ˜ í™•ì¸
BASE_DOMAIN=${BASE_DOMAIN:-"creatia.local"}

echo -e "${GREEN}ğŸ”§ Generating Caddyfile with BASE_DOMAIN=${BASE_DOMAIN}${NC}"

# Caddyfile.templateì„ ì‚¬ìš©í•˜ì—¬ Caddyfile ìƒì„±
if [ -f "Caddyfile.template" ]; then
    # envsubstë¥¼ ì‚¬ìš©í•˜ì—¬ í…œí”Œë¦¿ì—ì„œ í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
    export BASE_DOMAIN
    envsubst < Caddyfile.template > Caddyfile
    echo -e "${GREEN}âœ… Caddyfile generated successfully${NC}"
else
    # í…œí”Œë¦¿ì´ ì—†ìœ¼ë©´ ì§ì ‘ ìƒì„±
    cat > Caddyfile <<EOF
{
	auto_https off
}

http://${BASE_DOMAIN} {
	reverse_proxy localhost:3000 {
		header_up Host {http.request.host}
	}
}
EOF
    echo -e "${GREEN}âœ… Caddyfile created with BASE_DOMAIN=${BASE_DOMAIN}${NC}"
fi

# Caddyfile.devë„ ìƒì„±
if [ -f "Caddyfile.dev" ]; then
    # Caddyfile.dev ì—…ë°ì´íŠ¸
    sed -i.bak "s/BASE_DOMAIN=.*/BASE_DOMAIN=$BASE_DOMAIN/g" Caddyfile.dev
    rm Caddyfile.dev.bak
    echo -e "${GREEN}âœ… Caddyfile.dev updated with BASE_DOMAIN=${BASE_DOMAIN}${NC}"
fi

echo ""
echo "To start Caddy, run:"
echo "  caddy run --config Caddyfile --adapter caddyfile"