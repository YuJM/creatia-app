# MongoDB Local Development with Podman/Docker

# ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ê°ì§€ (Podman ìš°ì„ )
CONTAINER_RUNTIME := $(shell command -v podman 2> /dev/null || echo docker)
COMPOSE_RUNTIME := $(shell command -v podman-compose 2> /dev/null || echo docker-compose)

.PHONY: help up down restart logs shell mongo-shell status clean backup restore

help: ## ë„ì›€ë§ í‘œì‹œ
	@echo "MongoDB ë¡œì»¬ ê°œë°œ í™˜ê²½ ëª…ë ¹ì–´:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ì‚¬ìš©ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„: $(CONTAINER_RUNTIME)"
	@echo "ì‚¬ìš©ì¤‘ì¸ Compose ëŸ°íƒ€ì„: $(COMPOSE_RUNTIME)"

up: ## MongoDB Atlas Localê³¼ Mongo Express ì‹œì‘
	$(COMPOSE_RUNTIME) up -d
	@echo "âœ… MongoDB Atlas Localì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
	@echo "ğŸ“Š MongoDB: mongodb://localhost:27017"
	@echo "ğŸ” Mongo Express: http://localhost:8081 (admin/admin123)"

down: ## ì»¨í…Œì´ë„ˆ ì¤‘ì§€
	$(COMPOSE_RUNTIME) down
	@echo "â¹ï¸ MongoDBê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."

restart: ## ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
	$(COMPOSE_RUNTIME) restart
	@echo "ğŸ”„ MongoDBê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."

logs: ## ì»¨í…Œì´ë„ˆ ë¡œê·¸ ë³´ê¸°
	$(COMPOSE_RUNTIME) logs -f

mongo-shell: ## MongoDB ì‰˜ ì ‘ì†
	$(CONTAINER_RUNTIME) exec -it creatia_mongodb_atlas_local mongosh -u creatia_user -p creatia_pass --authenticationDatabase creatia_logs creatia_logs

shell: ## MongoDB ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†
	$(CONTAINER_RUNTIME) exec -it creatia_mongodb_atlas_local bash

status: ## ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
	$(COMPOSE_RUNTIME) ps
	@echo ""
	@echo "ğŸ“Š MongoDB ì—°ê²° ì •ë³´:"
	@echo "  - Host: localhost"
	@echo "  - Port: 27017"
	@echo "  - Database: creatia_logs"
	@echo "  - User: creatia_user"
	@echo "  - Password: creatia_pass"
	@echo "  - Admin User: admin"
	@echo "  - Admin Password: admin123"
	@echo ""
	@echo "ğŸ“ Rails .env ì„¤ì •:"
	@echo "  MONGODB_URI=mongodb://creatia_user:creatia_pass@localhost:27017/creatia_logs"

clean: ## ì»¨í…Œì´ë„ˆì™€ ë³¼ë¥¨ ì‚­ì œ (ì£¼ì˜: ë°ì´í„° ì†ì‹¤!)
	@echo "âš ï¸  ê²½ê³ : ëª¨ë“  MongoDB ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!"
	@echo "ê³„ì†í•˜ë ¤ë©´ 5ì´ˆ ë‚´ì— Ctrl+Cë¡œ ì·¨ì†Œí•˜ì„¸ìš”..."
	@sleep 5
	$(COMPOSE_RUNTIME) down -v
	@echo "ğŸ—‘ï¸ MongoDB ì»¨í…Œì´ë„ˆì™€ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."

backup: ## MongoDB ë°±ì—…
	@mkdir -p backups
	@BACKUP_FILE="backups/mongodb_backup_$$(date +%Y%m%d_%H%M%S).gz"
	$(CONTAINER_RUNTIME) exec creatia_mongodb_atlas_local mongodump -u creatia_user -p creatia_pass --db creatia_logs --archive --gzip > $$BACKUP_FILE
	@echo "âœ… ë°±ì—… ì™„ë£Œ: $$BACKUP_FILE"

restore: ## MongoDB ë³µì› (ìµœì‹  ë°±ì—… íŒŒì¼ ì‚¬ìš©)
	@LATEST_BACKUP=$$(ls -t backups/*.gz 2>/dev/null | head -1); \
	if [ -z "$$LATEST_BACKUP" ]; then \
		echo "âŒ ë°±ì—… íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; \
		exit 1; \
	fi; \
	echo "ë³µì›í•  ë°±ì—…: $$LATEST_BACKUP"; \
	cat $$LATEST_BACKUP | $(CONTAINER_RUNTIME) exec -i creatia_mongodb_atlas_local mongorestore -u creatia_user -p creatia_pass --db creatia_logs --archive --gzip
	@echo "âœ… ë³µì› ì™„ë£Œ!"

test-connection: ## Railsì—ì„œ MongoDB ì—°ê²° í…ŒìŠ¤íŠ¸
	cd ../.. && bin/rails mongoid:test_connection

create-sample-logs: ## ìƒ˜í”Œ ë¡œê·¸ ë°ì´í„° ìƒì„±
	cd ../.. && bin/rails mongoid:create_sample_logs

stats: ## ë¡œê·¸ í†µê³„ í™•ì¸
	cd ../.. && bin/rails mongoid:stats