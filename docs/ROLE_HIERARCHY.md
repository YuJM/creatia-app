# 역할 계층 구조 문서

## 📊 역할 개요

Creatia는 조직 내에서 5가지 주요 역할을 지원합니다:

1. **Owner (소유자)** - 최고 권한
2. **Admin (관리자)** - 관리 권한
3. **Member (멤버)** - 표준 권한
4. **Contributor (기여자)** - 제한된 쓰기 권한
5. **Viewer (뷰어)** - 읽기 전용

## 🔑 권한 매트릭스

### Organization (조직) 권한

| 작업 | Owner | Admin | Member | Contributor | Viewer |
|------|-------|-------|--------|-------------|--------|
| 조직 조회 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 조직 생성 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 조직 수정 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 조직 삭제 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 조직 전환 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 설정 관리 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 멤버 관리 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 빌링 관리 | ✅ | ❌ | ❌ | ❌ | ❌ |

### OrganizationMembership (멤버십) 권한

| 작업 | Owner | Admin | Member | Contributor | Viewer |
|------|-------|-------|--------|-------------|--------|
| 멤버십 목록 조회 | ✅ (전체) | ✅ (전체) | ✅ (활성화만) | ✅ (활성화만) | ✅ (활성화만) |
| 멤버십 상세 조회 | ✅ | ✅ | 🔸 (본인만) | 🔸 (본인만) | 🔸 (본인만) |
| 멤버 초대 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 멤버십 수정 | ✅ | ✅* | 🔸 (본인 설정만) | 🔸 (본인 설정만) | 🔸 (본인 설정만) |
| 멤버 제거 | ✅* | ✅* | 🔸 (본인 탈퇴만) | 🔸 (본인 탈퇴만) | ❌ |
| 역할 변경 | ✅ | ✅* | ❌ | ❌ | ❌ |
| 활성화/비활성화 | ✅* | ✅* | ❌ | ❌ | ❌ |

> *주의사항:
> - Admin은 Owner의 권한을 변경하거나 제거할 수 없음
> - Owner는 자신의 멤버십을 삭제할 수 없음 (조직에 최소 1명의 Owner 필요)
> - Owner 역할 이전은 Owner만 가능

### Task (작업) 권한

| 작업 | Owner | Admin | Member | Contributor | Viewer |
|------|-------|-------|--------|-------------|--------|
| Task 목록 조회 | ✅ (전체) | ✅ (전체) | 🔸 (할당/팀) | 🔸 (할당/팀) | 🔸 (할당만) |
| Task 상세 조회 | ✅ | ✅ | 🔸 (할당/팀) | 🔸 (할당/팀) | 🔸 (할당만) |
| Task 생성 | ✅ | ✅ | ✅ | ✅ | ❌ |
| Task 수정 | ✅ | ✅ | 🔸 (할당/생성자) | 🔸 (할당/생성자) | ❌ |
| Task 삭제 | ✅ | ✅ | 🔸 (생성자만) | 🔸 (생성자만) | ❌ |
| Task 할당 | ✅ | ✅ | 🔸 (팀장/생성자) | ❌ | ❌ |
| Task 완료 | 🔸 (할당된 경우) | 🔸 (할당된 경우) | 🔸 (할당/생성자) | 🔸 (할당/생성자) | ❌ |
| 포모도로 시작 | 🔸 (할당된 경우) | 🔸 (할당된 경우) | 🔸 (할당된 경우) | 🔸 (할당된 경우) | ❌ |

## 🎯 역할별 주요 특징

### Owner (소유자)
- 조직의 모든 권한 보유
- 조직 설정, 빌링, 삭제 권한
- 다른 멤버를 Owner로 승격 가능
- 자신의 멤버십 삭제 불가 (조직 보호)

### Admin (관리자)
- 일상적인 조직 관리 담당
- 멤버 초대, 제거, 역할 변경 (Owner 제외)
- 모든 Task 관리 가능
- 조직 설정이나 빌링 접근 불가

### Member (멤버)
- 표준 작업 권한
- Task 생성, 수정, 완료
- 자신이나 팀에 할당된 Task 접근
- 조직 탈퇴 가능

### Contributor (기여자)
- Member와 유사하나 일부 제한
- Task 생성 및 수정 가능
- 할당 권한 없음

### Viewer (뷰어)
- 읽기 전용 접근
- 할당된 Task만 조회 가능
- 생성, 수정, 삭제 불가

## 🔄 역할 전환 규칙

### 승격 가능 경로
```
Viewer → Contributor → Member → Admin → Owner
```

### 역할 변경 권한
- **Owner**: 모든 역할 변경 가능
- **Admin**: Owner를 제외한 모든 역할 변경 가능
- **기타**: 역할 변경 권한 없음

### 특별 규칙
1. **Owner 역할 이전**: 
   - 현재 Owner만 가능
   - 조직에는 최소 1명의 Owner 필요
   - Owner 이전 시 이전 Owner는 Admin으로 변경

2. **자기 자신의 역할**:
   - 자신의 역할은 변경 불가
   - Admin도 자신을 Owner로 승격 불가

3. **비활성 멤버십**:
   - 비활성 멤버는 모든 권한 상실
   - Admin/Owner만 재활성화 가능

## 💡 정책 구현 원칙

### 1. 명시적 거부 우선
```ruby
return false unless user && organization  # 명시적 거부
organization.member?(user)                # 그 다음 허용 체크
```

### 2. 계층적 권한 체크
```ruby
def admin?
  %w[owner admin].include?(role)  # Owner는 Admin 권한 포함
end
```

### 3. 컨텍스트 기반 권한
```ruby
def update?
  return true if own_membership?  # 자신의 설정
  return false if target_is_owner?  # Owner 보호
  admin?  # 일반 관리 권한
end
```

## 🐛 일반적인 권한 문제 해결

### 문제 1: Owner가 멤버로 인식되지 않음
**원인**: `member?` 메서드가 Owner를 포함하지 않음
**해결**: 
```ruby
def member?
  %w[owner admin member contributor].include?(role)
end
```

### 문제 2: Admin이 Owner 권한 변경
**원인**: 역할 체크 누락
**해결**:
```ruby
return false if target_is_owner? && !owner?
```

### 문제 3: 비활성 멤버가 접근 가능
**원인**: active 상태 체크 누락
**해결**:
```ruby
organization.member?(user) && membership.active?
```

## 📝 테스트 체크리스트

각 역할에 대해 다음 시나리오를 테스트하세요:

- [ ] 기본 CRUD 권한
- [ ] 자신의 리소스 vs 타인의 리소스
- [ ] 활성 vs 비활성 상태
- [ ] 역할 전환 시나리오
- [ ] 경계 케이스 (Owner 삭제, 마지막 Admin 등)
- [ ] Scope 필터링 정확성