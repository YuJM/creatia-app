# E2E 인증 테스트 수정 회고
날짜: 2025-08-29

## 문제 상황
- 모든 로그인이 필요한 E2E 테스트가 실패
- 크로스 도메인 인증이 작동하지 않음
- ERR_TOO_MANY_REDIRECTS 오류 발생

## 문제 해결 과정

### 1차 시도: 표면적 문제 해결 (빠른 해결)
- **문제**: Form field name 불일치 (`auth_user_user[email]` vs `user[email]`)
- **해결**: 테스트 코드의 selector 수정
- **결과**: 부분적 성공, 하지만 핵심 문제 미해결

### 2차 시도: 세션/쿠키 설정 확인 (중간 난이도)
- **조사 내용**:
  - Session store 설정: `domain: '.creatia.local'` ✅
  - JWT 토큰 설정: 올바른 도메인으로 설정됨 ✅
  - Devise SSO 설정: 정상 구성됨 ✅
- **발견**: 설정은 모두 올바르게 되어 있었음
- **교훈**: 설정이 맞다고 해서 동작한다는 보장은 없음

### 3차 시도: 런타임 로그 분석 (핵심 돌파구)
- **중요 발견**: `Pundit::NotAuthorizedError` - 인증은 되었지만 권한 검증 실패
- **근본 원인**: `ApplicationPolicy#member?` 메서드가 'owner' 역할을 멤버로 인식하지 못함
- **해결**: Policy 로직 수정으로 모든 테스트 통과

## 시간이 오래 걸린 이유

### 1. 잘못된 가정
- **초기 가정**: "크로스 도메인 인증 문제 = 쿠키/세션 설정 문제"
- **실제 원인**: 권한 정책 로직 오류
- **교훈**: 로그를 먼저 확인했다면 시간을 단축할 수 있었음

### 2. 디버깅 순서의 문제
```
실제 진행 순서:
1. 테스트 코드 수정 (표면적)
2. 설정 파일 확인 (인프라)
3. 로그 확인 (런타임) ← 이것을 먼저 했어야 함
```

**더 효율적인 순서**:
```
1. 로그/에러 메시지 확인 (문제 파악)
2. 관련 코드 추적 (근본 원인)
3. 수정 및 검증 (해결)
```

### 3. Sequential Thinking의 장단점
- **장점**: 체계적인 접근으로 모든 가능성 검토
- **단점**: 때로는 직관적 접근이 더 빠를 수 있음
- **개선점**: 로그 우선 확인을 체크리스트에 추가

## 핵심 교훈

### 1. 에러 메시지를 무시하지 말 것
- Rails 서버 로그의 `Pundit::NotAuthorizedError`가 핵심 단서였음
- 브라우저의 ERR_TOO_MANY_REDIRECTS는 결과일 뿐, 원인이 아니었음

### 2. 권한 시스템의 복잡성
```ruby
# 문제가 된 코드
def member?
  %w[member contributor].include?(organization.role_for(user))
end

# 수정된 코드
def member?
  return false unless organization_member?
  %w[owner admin member contributor].include?(organization.role_for(user))
end
```
- 역할 계층 구조를 명확히 이해해야 함
- owner는 당연히 member이지만, 코드는 그렇게 동작하지 않았음

### 3. 멀티테넌트 아키텍처의 복잡성
- 인증(Authentication) ✅
- 세션 관리 ✅  
- 권한 검증(Authorization) ❌ ← 실제 문제
- 각 레이어를 독립적으로 검증해야 함

## 개선 방안

### 1. 디버깅 체크리스트 개선
```markdown
□ 서버 로그 확인 (최우선)
□ 에러 메시지 전체 읽기
□ 스택 트레이스 추적
□ 관련 코드 확인
□ 설정 파일 검증 (필요시)
```

### 2. 테스트 개선
```javascript
// 더 명확한 테스트 추가
test('owner 역할로 조직 접근 가능', async ({ page }) => {
  // owner 권한 테스트
});

test('admin 역할로 조직 접근 가능', async ({ page }) => {
  // admin 권한 테스트  
});
```

### 3. Policy 테스트 강화
```ruby
# spec/policies/application_policy_spec.rb
describe '#member?' do
  it 'returns true for owner role' do
    # owner도 member로 인식되는지 확인
  end
end
```

## 시간 분석
- 총 소요 시간: 약 2시간
- Form field 수정: 20분
- 세션/쿠키 설정 조사: 40분
- 로그 분석 및 권한 오류 발견: 20분
- 수정 및 테스트: 20분
- **낭비된 시간**: 세션/쿠키 조사 40분 (로그를 먼저 봤다면 절약 가능)

## 결론
문제 해결에서 가장 중요한 것은 **정확한 문제 파악**이다. 에러 로그와 메시지는 문제를 직접적으로 알려주는 가장 중요한 단서다. Sequential thinking은 좋은 도구지만, 때로는 직관과 경험에 기반한 빠른 로그 확인이 더 효율적일 수 있다.

## Action Items
- [ ] Pundit policy에 대한 RSpec 테스트 추가
- [ ] 역할 계층 구조 문서화
- [ ] 디버깅 가이드라인 문서 작성
- [ ] E2E 테스트에 역할별 권한 테스트 추가